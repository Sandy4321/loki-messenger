name: Loki Messenger Automated Build

on: [pull_request]

jobs:
  build_linux:
    runs-on: ubuntu-latest
    env:
      SIGNAL_ENV: production
    steps:
      - name: Checkout git repo
        uses: actions/checkout@v1
      - name: Cache node modules
        uses: actions/cache@v1
        with:
          path: node_modules
          key: ${{ runner.OS }}-npm-${{ hashFiles('yarn.lock') }}
        # TODO: get this to detect .nvmrc
      - name: Install apt packages
        run: sudo apt-get install -y libgtk2.0-0 libgtk-3-0 libgconf-2-4 libasound2 libxtst6 libxss1 libnss3 xvfb hunspell-en-us
      - name: Set up node using nvm
        uses: dcodeIO/setup-node-nvm@v2.0.0
        with:
          node-version: 10.13
      - name: Install yarn
        run: npm install yarn --no-save
      - name: Install Dependencies
        run: yarn install --frozen-lockfile
      - name: Generate and concat files
        run: yarn generate
      - name: Run Tests
        run: yarn test
      - name: Lint Files
        run: yarn lint
      - name: Build Production Binaries
        run: $(yarn bin)/electron-builder --config.extraMetadata.environment=$SIGNAL_ENV --config.mac.bundleVersion='$GITHUB_REF' --publish=never --config.directories.output=release
